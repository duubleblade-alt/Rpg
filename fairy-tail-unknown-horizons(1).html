<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fairy Tail: Unknown Horizons</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-deep: #0a0a0f;
      --bg-panel: #101018;
      --bg-card: #18181f;
      --bg-input: #1e1e28;
      --accent-gold: #d4a574;
      --accent-gold-dim: rgba(212, 165, 116, 0.6);
      --accent-flame: #e85d04;
      --accent-magic: #9d8cff;
      --accent-success: #4ade80;
      --accent-time: #6bb8c9;
      --text-primary: #e8e4df;
      --text-secondary: #b8b4af;
      --text-muted: #7a7680;
      --text-dim: #4a4654;
      --border-subtle: rgba(212, 165, 116, 0.12);
      --border-hover: rgba(212, 165, 116, 0.3);
      --border-glow: rgba(212, 165, 116, 0.5);
      --shadow-glow: rgba(212, 165, 116, 0.15);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { scroll-behavior: smooth; }
    body {
      font-family: 'Crimson Text', Georgia, serif;
      background: var(--bg-deep);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.75;
      overflow-x: hidden;
    }
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background: 
        radial-gradient(ellipse at 15% 15%, rgba(157, 140, 255, 0.04) 0%, transparent 45%),
        radial-gradient(ellipse at 85% 85%, rgba(232, 93, 4, 0.03) 0%, transparent 45%),
        radial-gradient(ellipse at 50% 50%, rgba(212, 165, 116, 0.02) 0%, transparent 60%);
      pointer-events: none;
      z-index: 0;
    }
    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-track { background: var(--bg-deep); }
    ::-webkit-scrollbar-thumb { background: var(--border-subtle); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--accent-gold-dim); }

    /* SETUP SCREEN */
    .setup-screen {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      background: var(--bg-deep);
      padding: 2rem;
      overflow-y: auto;
    }
    .setup-screen.hidden { display: none; }
    .setup-container {
      width: 100%;
      max-width: 560px;
      padding: 2rem 0;
      animation: setupFadeIn 1s ease-out;
    }
    @keyframes setupFadeIn {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .setup-emblem { width: 80px; height: 80px; margin: 0 auto 1.5rem; opacity: 0.8; }
    .setup-emblem svg { width: 100%; height: 100%; fill: var(--accent-gold); }
    .setup-title {
      font-family: 'Cinzel', serif;
      font-size: clamp(2rem, 6vw, 2.8rem);
      font-weight: 700;
      text-align: center;
      margin-bottom: 0.25rem;
      background: linear-gradient(135deg, var(--accent-gold) 0%, var(--accent-flame) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: 0.08em;
    }
    .setup-subtitle {
      font-family: 'Cinzel', serif;
      font-size: 0.85rem;
      text-align: center;
      color: var(--text-muted);
      letter-spacing: 0.35em;
      margin-bottom: 3rem;
    }
    .setup-section { margin-bottom: 1.75rem; }
    .setup-label {
      font-family: 'Cinzel', serif;
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--accent-gold);
      letter-spacing: 0.2em;
      margin-bottom: 0.6rem;
      display: block;
      text-transform: uppercase;
    }
    .setup-input {
      width: 100%;
      padding: 0.95rem 1.1rem;
      background: var(--bg-input);
      border: 1px solid var(--border-subtle);
      border-radius: 3px;
      color: var(--text-primary);
      font-family: 'Crimson Text', serif;
      font-size: 1.1rem;
      transition: all 0.3s;
    }
    .setup-input:focus {
      outline: none;
      border-color: var(--border-glow);
      background: var(--bg-card);
      box-shadow: 0 0 25px var(--shadow-glow);
    }
    .setup-input::placeholder { color: var(--text-dim); }
    .setup-textarea { min-height: 180px; resize: vertical; line-height: 1.7; }
    .setup-hint {
      font-size: 0.9rem;
      color: var(--text-dim);
      font-style: italic;
      margin-top: 0.6rem;
      padding-left: 0.5rem;
      border-left: 2px solid var(--border-subtle);
    }
    .setup-button {
      width: 100%;
      padding: 1.15rem;
      margin-top: 2.5rem;
      font-family: 'Cinzel', serif;
      font-size: 0.9rem;
      font-weight: 600;
      letter-spacing: 0.25em;
      color: var(--bg-deep);
      background: linear-gradient(135deg, var(--accent-gold) 0%, var(--accent-flame) 100%);
      border: none;
      border-radius: 3px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.3s, opacity 0.3s;
      text-transform: uppercase;
    }
    .setup-button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(212, 165, 116, 0.35);
    }
    .setup-button:disabled { opacity: 0.5; cursor: not-allowed; }
    .api-status { text-align: center; margin-top: 1.25rem; font-size: 0.95rem; color: var(--text-muted); }
    .api-status.error { color: var(--accent-flame); }
    .api-status.success { color: var(--accent-success); }

    /* GAME SCREEN */
    .game-screen { display: none; min-height: 100vh; position: relative; z-index: 1; }
    .game-screen.active { display: block; animation: gameFadeIn 0.8s ease-out; }
    @keyframes gameFadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* STATUS TOGGLE */
    .status-toggle {
      position: fixed;
      top: 1.25rem;
      left: 1.25rem;
      width: 42px;
      height: 42px;
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 60;
      transition: all 0.3s;
    }
    .status-toggle:hover { border-color: var(--accent-gold); box-shadow: 0 0 20px var(--shadow-glow); }
    .status-toggle svg { width: 18px; height: 18px; fill: var(--accent-gold); transition: transform 0.3s; }
    .status-toggle.active svg { transform: rotate(90deg); }

    /* STATUS PANEL */
    .status-panel {
      position: fixed;
      top: 0;
      left: 0;
      width: 300px;
      height: 100vh;
      background: var(--bg-panel);
      border-right: 1px solid var(--border-subtle);
      transform: translateX(-100%);
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 55;
      overflow-y: auto;
    }
    .status-panel.open { transform: translateX(0); }
    .status-panel-inner { padding: 4.5rem 1.5rem 2rem; }
    .status-section { margin-bottom: 1.75rem; }
    .status-section-header {
      font-family: 'Cinzel', serif;
      font-size: 0.65rem;
      font-weight: 600;
      color: var(--text-dim);
      letter-spacing: 0.25em;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border-subtle);
      text-transform: uppercase;
    }
    .status-name {
      font-family: 'Cinzel', serif;
      font-size: 1.35rem;
      font-weight: 600;
      color: var(--accent-gold);
      margin-bottom: 0.2rem;
    }
    .status-magic-type { font-size: 1rem; color: var(--accent-magic); font-style: italic; }
    .status-condition {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-top: 0.75rem;
      padding: 0.5rem 0.75rem;
      background: rgba(212, 165, 116, 0.05);
      border-left: 2px solid var(--accent-gold-dim);
      border-radius: 0 3px 3px 0;
    }

    /* TEMPORAL STATE */
    .temporal-display {
      background: rgba(107, 184, 201, 0.08);
      border: 1px solid rgba(107, 184, 201, 0.2);
      border-radius: 4px;
      padding: 0.75rem;
      margin-bottom: 1rem;
    }
    .temporal-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.4rem;
    }
    .temporal-row:last-child { margin-bottom: 0; }
    .temporal-label {
      font-family: 'Cinzel', serif;
      font-size: 0.6rem;
      font-weight: 600;
      color: var(--accent-time);
      letter-spacing: 0.15em;
      text-transform: uppercase;
    }
    .temporal-value {
      font-size: 0.95rem;
      color: var(--text-primary);
    }
    .temporal-period {
      font-size: 0.8rem;
      color: var(--text-muted);
      text-align: center;
      margin-top: 0.5rem;
      font-style: italic;
    }

    /* BEAT COUNTER */
    .beat-display {
      text-align: center;
      padding: 0.5rem;
      background: rgba(212, 165, 116, 0.05);
      border-radius: 3px;
      margin-top: 0.75rem;
    }
    .beat-label {
      font-family: 'Cinzel', serif;
      font-size: 0.55rem;
      color: var(--text-dim);
      letter-spacing: 0.2em;
      text-transform: uppercase;
    }
    .beat-value {
      font-family: 'Cinzel', serif;
      font-size: 1.1rem;
      color: var(--accent-gold);
      font-weight: 600;
    }

    .status-stat { margin-bottom: 1.1rem; }
    .stat-row { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 0.35rem; }
    .stat-label {
      font-family: 'Cinzel', serif;
      font-size: 0.65rem;
      font-weight: 600;
      color: var(--text-muted);
      letter-spacing: 0.15em;
      text-transform: uppercase;
    }
    .stat-value { font-size: 1.05rem; color: var(--text-primary); font-weight: 600; }
    .stat-bar-container { height: 3px; background: var(--bg-deep); border-radius: 2px; overflow: hidden; }
    .stat-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-gold), var(--accent-flame));
      border-radius: 2px;
      transition: width 0.6s ease-out;
    }
    .inventory-list { list-style: none; }
    .inventory-item {
      font-size: 0.95rem;
      color: var(--text-secondary);
      padding: 0.4rem 0 0.4rem 1rem;
      position: relative;
    }
    .inventory-item::before { content: '◇'; position: absolute; left: 0; color: var(--accent-gold-dim); font-size: 0.7rem; }
    .inventory-empty { font-size: 0.9rem; color: var(--text-dim); font-style: italic; }
    .relationship-entry { margin-bottom: 0.9rem; }
    .relationship-name { font-family: 'Cinzel', serif; font-size: 0.9rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.15rem; }
    .relationship-status { font-size: 0.85rem; color: var(--text-muted); font-style: italic; }
    .relationship-status.mystery { color: var(--text-dim); letter-spacing: 0.1em; }

    /* NARRATIVE */
    .narrative-container { max-width: 700px; margin: 0 auto; padding: 3.5rem 2rem 14rem; position: relative; }
    .chapter-marker {
      font-family: 'Cinzel', serif;
      font-size: 0.75rem;
      font-weight: 600;
      letter-spacing: 0.4em;
      color: var(--text-dim);
      text-align: center;
      margin-bottom: 2.5rem;
      text-transform: uppercase;
    }
    .narrative-content { min-height: 50vh; }
    .narrative-text { font-size: 1.15rem; line-height: 1.95; color: var(--text-primary); }
    .narrative-text p { margin-bottom: 1.6rem; text-indent: 1.5em; }
    .narrative-text p:first-of-type { text-indent: 0; }
    .narrative-text p:first-of-type::first-letter {
      font-family: 'Cinzel', serif;
      font-size: 3.8rem;
      float: left;
      line-height: 0.85;
      padding-right: 0.12em;
      padding-top: 0.05em;
      color: var(--accent-gold);
      font-weight: 700;
    }
    .narrative-divider { text-align: center; margin: 2.5rem 0; color: var(--text-dim); font-size: 1.2rem; letter-spacing: 0.5em; }
    .player-action {
      margin: 2rem 0;
      padding: 1rem 1.25rem;
      background: rgba(157, 140, 255, 0.04);
      border-left: 2px solid var(--accent-magic);
      border-radius: 0 3px 3px 0;
      font-style: italic;
      color: var(--text-secondary);
    }
    .player-action::before { content: '› '; color: var(--accent-magic); }

    /* BEAT MARKER IN NARRATIVE */
    .beat-marker {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      margin: 1.5rem 0;
      color: var(--text-dim);
      font-size: 0.7rem;
      font-family: 'Cinzel', serif;
      letter-spacing: 0.15em;
    }
    .beat-marker::before,
    .beat-marker::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border-subtle);
      max-width: 80px;
    }

    .loading-indicator { display: none; padding: 2.5rem 1rem; text-align: center; }
    .loading-indicator.active { display: block; }
    .loading-text { color: var(--text-muted); font-style: italic; margin-bottom: 1rem; }
    .loading-bar { width: 200px; height: 2px; background: var(--bg-card); margin: 0 auto; border-radius: 1px; overflow: hidden; }
    .loading-bar-inner {
      height: 100%;
      width: 30%;
      background: linear-gradient(90deg, var(--accent-gold), var(--accent-flame));
      animation: loadingSlide 1.2s ease-in-out infinite;
    }
    @keyframes loadingSlide { 0% { transform: translateX(-100%); } 100% { transform: translateX(400%); } }
    .coherence-indicator { font-size: 0.8rem; color: var(--text-dim); margin-top: 0.75rem; }

    .prologue-end { text-align: center; margin-top: 3rem; padding-top: 2.5rem; border-top: 1px solid var(--border-subtle); animation: prologueEndFade 1s ease-out; }
    .prologue-end.hidden { display: none; }
    @keyframes prologueEndFade { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .prologue-end-text { font-family: 'Cinzel', serif; font-size: 0.9rem; color: var(--text-muted); letter-spacing: 0.15em; margin-bottom: 1.75rem; }
    .enter-guild-button {
      padding: 1.1rem 3.5rem;
      font-family: 'Cinzel', serif;
      font-size: 0.85rem;
      font-weight: 600;
      letter-spacing: 0.2em;
      color: var(--bg-deep);
      background: linear-gradient(135deg, var(--accent-gold), var(--accent-flame));
      border: none;
      border-radius: 3px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.3s;
      text-transform: uppercase;
    }
    .enter-guild-button:hover { transform: translateY(-2px); box-shadow: 0 10px 35px rgba(212, 165, 116, 0.4); }

    /* INPUT */
    .input-area {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(to top, var(--bg-deep) 0%, var(--bg-deep) 70%, transparent 100%);
      padding: 1rem 2rem 1.75rem;
      z-index: 40;
    }
    .input-container { max-width: 700px; margin: 0 auto; display: flex; gap: 0.75rem; align-items: flex-end; }
    .input-wrapper { flex: 1; }
    .input-field {
      width: 100%;
      padding: 0.9rem 1.15rem;
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: 3px;
      color: var(--text-primary);
      font-family: 'Crimson Text', serif;
      font-size: 1.1rem;
      resize: none;
      min-height: 50px;
      max-height: 140px;
      line-height: 1.5;
      transition: all 0.3s;
    }
    .input-field:focus { outline: none; border-color: var(--border-hover); box-shadow: 0 0 20px var(--shadow-glow); }
    .input-field::placeholder { color: var(--text-dim); font-style: italic; }
    .input-field:disabled { opacity: 0.5; cursor: not-allowed; }
    .send-button {
      width: 50px;
      height: 50px;
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: 3px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
      flex-shrink: 0;
    }
    .send-button:hover:not(:disabled) { border-color: var(--accent-gold); background: rgba(212, 165, 116, 0.08); }
    .send-button:disabled { opacity: 0.35; cursor: not-allowed; }
    .send-button svg { width: 18px; height: 18px; fill: var(--accent-gold); transition: transform 0.2s; }
    .send-button:hover:not(:disabled) svg { transform: translateX(2px); }

    .save-indicator {
      position: fixed;
      top: 1.25rem;
      right: 1.25rem;
      font-family: 'Cinzel', serif;
      font-size: 0.65rem;
      font-weight: 600;
      color: var(--accent-success);
      letter-spacing: 0.15em;
      opacity: 0;
      transform: translateY(-5px);
      transition: all 0.3s;
      text-transform: uppercase;
    }
    .save-indicator.visible { opacity: 1; transform: translateY(0); }

    .reset-button {
      position: fixed;
      bottom: 5.5rem;
      right: 1.25rem;
      font-family: 'Cinzel', serif;
      font-size: 0.6rem;
      font-weight: 600;
      color: var(--text-dim);
      background: transparent;
      border: 1px solid var(--border-subtle);
      padding: 0.45rem 0.85rem;
      border-radius: 3px;
      cursor: pointer;
      letter-spacing: 0.12em;
      transition: all 0.3s;
      z-index: 35;
      text-transform: uppercase;
    }
    .reset-button:hover { color: var(--accent-flame); border-color: rgba(232, 93, 4, 0.4); background: rgba(232, 93, 4, 0.05); }

    .error-message {
      background: rgba(232, 93, 4, 0.1);
      border: 1px solid rgba(232, 93, 4, 0.3);
      border-radius: 3px;
      padding: 1rem 1.25rem;
      margin: 1.5rem 0;
      color: var(--accent-flame);
    }

    @media (max-width: 768px) {
      .narrative-container { padding: 3rem 1.25rem 13rem; }
      .narrative-text { font-size: 1.1rem; }
      .narrative-text p:first-of-type::first-letter { font-size: 3rem; }
      .status-panel { width: 100%; }
      .input-area { padding: 1rem 1rem 1.5rem; }
    }
  </style>
</head>
<body>
  <!-- SETUP SCREEN -->
  <div class="setup-screen" id="setupScreen">
    <div class="setup-container">
      <div class="setup-emblem">
        <svg viewBox="0 0 100 100"><path d="M50 5 L55 25 L75 15 L65 35 L90 40 L70 50 L90 60 L65 65 L75 85 L55 75 L50 95 L45 75 L25 85 L35 65 L10 60 L30 50 L10 40 L35 35 L25 15 L45 25 Z"/></svg>
      </div>
      <h1 class="setup-title">FAIRY TAIL</h1>
      <p class="setup-subtitle">UNKNOWN HORIZONS</p>
      <div class="setup-section">
        <label class="setup-label">Gemini API Key</label>
        <input type="password" class="setup-input" id="apiKeyInput" placeholder="Enter your Gemini API key..." autocomplete="off">
      </div>
      <div class="setup-section">
        <label class="setup-label">Character Name</label>
        <input type="text" class="setup-input" id="charNameInput" placeholder="What is your name?">
      </div>
      <div class="setup-section">
        <label class="setup-label">Magic Type</label>
        <input type="text" class="setup-input" id="magicTypeInput" placeholder="What magic do you wield?">
      </div>
      <div class="setup-section">
        <label class="setup-label">Biography</label>
        <textarea class="setup-input setup-textarea" id="biographyInput" placeholder="Tell your story...&#10;&#10;Who are you? What are you running from? Why do you seek Fairy Tail?"></textarea>
        <p class="setup-hint">Your past shapes your future. The more detail, the richer your journey.</p>
      </div>
      <button class="setup-button" id="beginButton">Begin Your Journey</button>
      <p class="api-status" id="apiStatus"></p>
    </div>
  </div>

  <!-- GAME SCREEN -->
  <div class="game-screen" id="gameScreen">
    <button class="status-toggle" id="statusToggle" aria-label="Toggle status">
      <svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
    </button>

    <aside class="status-panel" id="statusPanel">
      <div class="status-panel-inner">
        <!-- TEMPORAL STATE -->
        <div class="status-section">
          <div class="status-section-header">Time</div>
          <div class="temporal-display">
            <div class="temporal-row">
              <span class="temporal-label">Day</span>
              <span class="temporal-value" id="displayDay">1</span>
            </div>
            <div class="temporal-row">
              <span class="temporal-label">Time</span>
              <span class="temporal-value" id="displayTime">Late Afternoon</span>
            </div>
            <div class="temporal-period" id="displayPeriod">The sun hangs low</div>
          </div>
          <div class="beat-display">
            <div class="beat-label">Scene Beat</div>
            <div class="beat-value" id="displayBeat">1</div>
          </div>
        </div>

        <!-- IDENTITY -->
        <div class="status-section">
          <div class="status-section-header">Identity</div>
          <div class="status-name" id="displayName">—</div>
          <div class="status-magic-type" id="displayMagic">—</div>
          <div class="status-condition" id="displayCondition">—</div>
        </div>

        <!-- ATTRIBUTES -->
        <div class="status-section">
          <div class="status-section-header">Attributes</div>
          <div class="status-stat">
            <div class="stat-row">
              <span class="stat-label">Level</span>
              <span class="stat-value" id="displayLevel">1</span>
            </div>
            <div class="stat-bar-container"><div class="stat-bar" id="expBar" style="width:0%"></div></div>
          </div>
          <div class="status-stat">
            <div class="stat-row">
              <span class="stat-label">Magic Power</span>
              <span class="stat-value" id="displayMagicPower">10</span>
            </div>
          </div>
        </div>

        <!-- INVENTORY -->
        <div class="status-section">
          <div class="status-section-header">Belongings</div>
          <ul class="inventory-list" id="inventoryList">
            <li class="inventory-empty">Nothing but the clothes on your back.</li>
          </ul>
        </div>

        <!-- BONDS -->
        <div class="status-section">
          <div class="status-section-header">Bonds</div>
          <div class="relationship-entry">
            <div class="relationship-name">Levy McGarden</div>
            <div class="relationship-status mystery" id="levyStatus">? ? ?</div>
          </div>
          <div class="relationship-entry">
            <div class="relationship-name">Freed Justine</div>
            <div class="relationship-status mystery" id="freedStatus">? ? ?</div>
          </div>
        </div>
      </div>
    </aside>

    <div class="save-indicator" id="saveIndicator">✓ Saved</div>

    <main class="narrative-container">
      <div class="chapter-marker" id="chapterMarker">PROLOGUE</div>
      <div class="narrative-content" id="narrativeContent">
        <div class="narrative-text" id="narrativeText"></div>
        <div class="loading-indicator" id="loadingIndicator">
          <div class="loading-text">The threads of fate are weaving...</div>
          <div class="loading-bar"><div class="loading-bar-inner"></div></div>
          <div class="coherence-indicator" id="coherenceIndicator"></div>
        </div>
        <div class="prologue-end hidden" id="prologueEnd">
          <p class="prologue-end-text">You stand before the doors of Fairy Tail.</p>
          <button class="enter-guild-button" id="enterGuildButton">Push Open the Doors</button>
        </div>
      </div>
    </main>

    <div class="input-area" id="inputArea">
      <div class="input-container">
        <div class="input-wrapper">
          <textarea class="input-field" id="playerInput" placeholder="What do you do?" rows="1"></textarea>
        </div>
        <button class="send-button" id="sendButton" aria-label="Send">
          <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
        </button>
      </div>
    </div>

    <button class="reset-button" id="resetButton">Reset Journey</button>
  </div>

  <script>
    // ============================================================
    // CONSTANTS
    // ============================================================
    const STORAGE_KEY = 'fairytail_unknown_horizons_v4';
    const GEMINI_MODEL = 'gemini-3-pro-preview';
    const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent`;

    const ROMANCE_STAGES = [
      { name: 'Strangers', threshold: 0 },
      { name: 'Acquaintance', threshold: 20 },
      { name: 'Curiosity', threshold: 50 },
      { name: 'Friendship', threshold: 100 },
      { name: 'Closeness', threshold: 175 },
      { name: 'Tension', threshold: 275 },
      { name: 'Confession', threshold: 400 },
      { name: 'Devoted', threshold: 550 }
    ];

    const RIVALRY_STAGES = [
      { name: 'Unnoticed', threshold: 0 },
      { name: 'Observed', threshold: 15 },
      { name: 'Dismissed', threshold: 30 },
      { name: 'Acknowledged', threshold: 50 },
      { name: 'Contested', threshold: 75 },
      { name: 'Rival', threshold: 100 },
      { name: 'Respected Rival', threshold: 150 }
    ];

    // Canon timeline: Game starts X779, 5 years before main story (X779)
    const GAME_YEAR = 'X779';
    const TIMELINE_NOTE = '5 years before canon events';

    const TIME_PERIODS = [
      { name: 'Dawn', hour: 5, description: 'The first light breaks' },
      { name: 'Early Morning', hour: 7, description: 'Morning dew still clings' },
      { name: 'Morning', hour: 9, description: 'The day awakens fully' },
      { name: 'Late Morning', hour: 11, description: 'The sun climbs higher' },
      { name: 'Midday', hour: 12, description: 'The sun stands at its peak' },
      { name: 'Early Afternoon', hour: 13, description: 'The afternoon begins' },
      { name: 'Afternoon', hour: 15, description: 'The day stretches on' },
      { name: 'Late Afternoon', hour: 17, description: 'The sun hangs low' },
      { name: 'Dusk', hour: 19, description: 'Golden light fades' },
      { name: 'Evening', hour: 20, description: 'Night approaches' },
      { name: 'Night', hour: 22, description: 'Darkness has fallen' },
      { name: 'Late Night', hour: 0, description: 'The world sleeps' },
      { name: 'Deep Night', hour: 3, description: 'The darkest hours' }
    ];

    // ============================================================
    // GAME STATE
    // ============================================================
    let gameState = {
      apiKey: '',
      character: {
        name: '',
        magicType: '',
        biography: '',
        level: 1,
        exp: 0,
        magicPower: 10,
        condition: 'Weary from the road'
      },
      inventory: [],
      relationships: {
        levy: { points: 0, revealed: false },
        freed: { rivalry: 0, respect: 0, revealed: false }
      },
      temporal: {
        day: 1,
        hour: 17, // Start at late afternoon
        beat: 1,
        minutesInBeat: 0
      },
      story: {
        phase: 'prologue',
        atGuildDoors: false,
        enteredGuild: false,
        narrativeHistory: [],
        establishedFacts: [],
        currentLocation: 'Road to Magnolia'
      },
      conversationHistory: []
    };

    // ============================================================
    // DOM ELEMENTS
    // ============================================================
    const el = {
      setupScreen: document.getElementById('setupScreen'),
      apiKeyInput: document.getElementById('apiKeyInput'),
      charNameInput: document.getElementById('charNameInput'),
      magicTypeInput: document.getElementById('magicTypeInput'),
      biographyInput: document.getElementById('biographyInput'),
      beginButton: document.getElementById('beginButton'),
      apiStatus: document.getElementById('apiStatus'),
      gameScreen: document.getElementById('gameScreen'),
      statusToggle: document.getElementById('statusToggle'),
      statusPanel: document.getElementById('statusPanel'),
      narrativeText: document.getElementById('narrativeText'),
      loadingIndicator: document.getElementById('loadingIndicator'),
      coherenceIndicator: document.getElementById('coherenceIndicator'),
      playerInput: document.getElementById('playerInput'),
      sendButton: document.getElementById('sendButton'),
      prologueEnd: document.getElementById('prologueEnd'),
      enterGuildButton: document.getElementById('enterGuildButton'),
      chapterMarker: document.getElementById('chapterMarker'),
      saveIndicator: document.getElementById('saveIndicator'),
      resetButton: document.getElementById('resetButton'),
      displayName: document.getElementById('displayName'),
      displayMagic: document.getElementById('displayMagic'),
      displayCondition: document.getElementById('displayCondition'),
      displayLevel: document.getElementById('displayLevel'),
      displayMagicPower: document.getElementById('displayMagicPower'),
      expBar: document.getElementById('expBar'),
      inventoryList: document.getElementById('inventoryList'),
      levyStatus: document.getElementById('levyStatus'),
      freedStatus: document.getElementById('freedStatus'),
      displayDay: document.getElementById('displayDay'),
      displayTime: document.getElementById('displayTime'),
      displayPeriod: document.getElementById('displayPeriod'),
      displayBeat: document.getElementById('displayBeat')
    };

    // ============================================================
    // TEMPORAL HELPERS
    // ============================================================
    function getCurrentTimePeriod() {
      const hour = gameState.temporal.hour;
      let period = TIME_PERIODS[0];
      for (const p of TIME_PERIODS) {
        if (hour >= p.hour) period = p;
      }
      // Handle wrap-around for late night
      if (hour < 5) {
        period = TIME_PERIODS.find(p => p.hour === 0) || TIME_PERIODS[TIME_PERIODS.length - 2];
        if (hour >= 3) period = TIME_PERIODS.find(p => p.hour === 3) || period;
      }
      return period;
    }

    function advanceTime(minutes) {
      gameState.temporal.minutesInBeat += minutes;
      const totalMinutes = gameState.temporal.hour * 60 + minutes;
      const newTotalMinutes = totalMinutes + minutes;
      
      gameState.temporal.hour = Math.floor(newTotalMinutes / 60) % 24;
      
      // Check for day change
      if (newTotalMinutes >= 24 * 60) {
        gameState.temporal.day++;
      }
    }

    function advanceBeat() {
      gameState.temporal.beat++;
      gameState.temporal.minutesInBeat = 0;
    }

    function formatTimeForDisplay() {
      const period = getCurrentTimePeriod();
      return {
        time: period.name,
        description: period.description
      };
    }

    // ============================================================
    // GEMINI API
    // ============================================================
    async function callGemini(prompt, systemPrompt = '', temperature = 0.7, includeHistory = false) {
      const contents = [];
      
      if (systemPrompt) {
        contents.push({ role: 'user', parts: [{ text: `[SYSTEM]\n${systemPrompt}\n[/SYSTEM]\n\nAcknowledge.` }] });
        contents.push({ role: 'model', parts: [{ text: 'Understood. I will follow these instructions precisely.' }] });
      }
      
      // Include last 6 conversation exchanges for context if requested
      if (includeHistory && gameState.conversationHistory && gameState.conversationHistory.length > 0) {
        const recentHistory = gameState.conversationHistory.slice(-12); // Last 6 exchanges (12 messages)
        recentHistory.forEach(msg => {
          const role = msg.role === 'assistant' ? 'model' : 'user';
          contents.push({ role: role, parts: [{ text: msg.content }] });
        });
      }

      contents.push({ role: 'user', parts: [{ text: prompt }] });

      const res = await fetch(`${GEMINI_API_URL}?key=${gameState.apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents,
          generationConfig: { temperature, topP: 0.95, topK: 40, maxOutputTokens: 4096 }
        })
      });

      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        throw new Error(err.error?.message || `API error: ${res.status}`);
      }

      const data = await res.json();
      return data.candidates?.[0]?.content?.parts?.[0]?.text || '';
    }

    // ============================================================
    // CONTEXT BUILDING
    // ============================================================
    function buildContext() {
      const history = gameState.story.narrativeHistory.slice(-8);
      const facts = gameState.story.establishedFacts.slice(-15);
      const timePeriod = getCurrentTimePeriod();
      
      return `
═══ TIMELINE ═══
Year: ${GAME_YEAR} (${TIMELINE_NOTE})
Note: Natsu, Lucy, Gray, Erza are younger. Major canon events have not occurred yet.

═══ TEMPORAL STATE ═══
Day: ${gameState.temporal.day}
Time: ${timePeriod.name} (Hour ${gameState.temporal.hour})
Scene Beat: ${gameState.temporal.beat}
Atmosphere: ${timePeriod.description}

═══ CHARACTER ═══
Name: ${gameState.character.name}
Magic: ${gameState.character.magicType}
Level: ${gameState.character.level} | Magic Power: ${gameState.character.magicPower}
Condition: ${gameState.character.condition}
Location: ${gameState.story.currentLocation}

Biography:
${gameState.character.biography}

═══ INVENTORY ═══
${gameState.inventory.length ? gameState.inventory.join(', ') : 'Empty'}

═══ STORY STATE ═══
Phase: ${gameState.story.phase}
At Guild Doors: ${gameState.story.atGuildDoors}
Entered Guild: ${gameState.story.enteredGuild}

═══ ESTABLISHED FACTS ═══
${facts.length ? facts.map((f,i) => `${i+1}. ${f}`).join('\n') : 'None'}

═══ RECENT BEATS ═══
${history.length ? history.map((e,i) => `[Beat ${e.beat}] ${e.action}: ${e.summary}`).join('\n') : 'Beginning'}

═══ LEVY MCGARDEN (ROMANCE) ═══
Points: ${gameState.relationships.levy.points} | Stage: ${getLevyStage().name}

═══ FREED JUSTINE (RIVALRY) ═══
Rivalry: ${gameState.relationships.freed.rivalry} | Respect: ${gameState.relationships.freed.respect}
Stage: ${getFreedStage().name}
`.trim();
    }

    function getLevyStage() {
      let stage = ROMANCE_STAGES[0];
      for (const s of ROMANCE_STAGES) {
        if (gameState.relationships.levy.points >= s.threshold) stage = s;
      }
      return stage;
    }

    function getFreedStage() {
      const combined = gameState.relationships.freed.rivalry + gameState.relationships.freed.respect;
      let stage = RIVALRY_STAGES[0];
      for (const s of RIVALRY_STAGES) {
        if (combined >= s.threshold) stage = s;
      }
      return stage;
    }

    // ============================================================
    // TWO-PASS SYSTEM WITH SCENE BEAT ENFORCEMENT
    // ============================================================
    async function coherencePass(action) {
      updateCoherence('Checking story coherence...');
      
      const timePeriod = getCurrentTimePeriod();
      
      const sys = `You are the COHERENCE GUARDIAN for a Fairy Tail RPG using a SCENE BEAT SYSTEM.

CRITICAL PACING RULES:
1. Each response = ONE SCENE BEAT (max 5-10 minutes of story time)
2. NO TIMESKIPS unless player explicitly requests one
3. NO montages, NO "time passes", NO summaries of events
4. Every moment must be LIVED, not summarized
5. Transitions happen step by step (walking somewhere = describe the walk)
6. If player tries to skip ahead, the beat shows what happens DURING that time

CURRENT TEMPORAL STATE:
- Day: ${gameState.temporal.day}
- Time: ${timePeriod.name} (Hour ${gameState.temporal.hour})
- Current Beat: ${gameState.temporal.beat}

CONTEXT:
${buildContext()}

Analyze the action and respond with ONLY JSON:
{
  "coherent": true/false,
  "issues": ["any contradictions or problems"],
  "suggestions": ["narrative adjustments"],
  "newFacts": ["facts to establish"],
  "conditionUpdate": "new condition or null",
  "inventoryChanges": {"add":[], "remove":[]},
  "locationUpdate": "new location or null",
  "levyPoints": 0,
  "freedRivalry": 0,
  "freedRespect": 0,
  "timeAdvance": {
    "minutes": 0-10,
    "isTimeskip": false,
    "skipToHour": null,
    "skipDays": 0
  },
  "pacingNotes": "guidance for maintaining beat-level granularity"
}

For timeAdvance:
- Normal beat: 1-10 minutes
- Only set isTimeskip:true if player EXPLICITLY requests it (e.g., "I wait until morning", "I sleep")
- If timeskip requested, set skipToHour and/or skipDays

Award levyPoints 0-5 only for positive Levy interactions after guild entry.

For freedRivalry: Award -5 to +5 for rivalry-building interactions (confrontations, competitions, disagreements increase; avoiding him decreases)
For freedRespect: Award 0 to +3 for respect-building moments (showing strength, honor, protecting allies, magical skill)

FREED JUSTINE CONTEXT:
- Captain of the Thunder Legion, fiercely loyal to Laxus
- Master of Dark Écriture (rune/letter magic) - writes rules into reality
- Proud, elegant, initially dismissive of newcomers who haven't proven themselves
- Respects strength, intelligence, and honorable conduct
- Close friends with Levy (both love books/languages) - creates interesting tension
- In X779: Thunder Legion is elite but not yet antagonistic (Fantasia arc is years away)`;

      try {
        const res = await callGemini(`ACTION: "${action}"\n\nAnalyze for coherence and pacing. JSON only.`, sys, 0.3);
        const match = res.match(/\{[\s\S]*\}/);
        if (match) {
          const parsed = JSON.parse(match[0]);
          updateCoherence(parsed.coherent ? 'Coherence verified ✓' : 'Adjusting...');
          return parsed;
        }
      } catch (e) { console.error('Coherence error:', e); }
      
      updateCoherence('Proceeding...');
      return { 
        coherent: true, 
        issues: [], 
        suggestions: [], 
        newFacts: [], 
        conditionUpdate: null, 
        inventoryChanges: { add: [], remove: [] }, 
        locationUpdate: null, 
        levyPoints: 0,
        timeAdvance: { minutes: 5, isTimeskip: false, skipToHour: null, skipDays: 0 },
        pacingNotes: ''
      };
    }

    async function generationPass(input, coherence) {
      updateCoherence('Weaving narrative...');
      
      const timePeriod = getCurrentTimePeriod();
      
      const prologueInstr = gameState.story.phase === 'prologue' ? `
═══ PROLOGUE ═══
Final approach to Magnolia. Character has:
- Been running for ONE YEAR
- Traveled toward Fairy Tail for ONE MONTH
- Weave hints of what they flee (from biography)
- Build atmosphere: exhaustion, hope, fear
- END when they reach guild doors - describe the doors, sounds within
- Do NOT enter the guild yet` : '';

      const guildInstr = gameState.story.enteredGuild ? `
═══ MAIN STORY ═══
Character has entered Fairy Tail.

TIMELINE: Year X779 - Five years before main canon events
- Natsu (younger, still searching for Igneel), Lucy has NOT joined yet
- Gray, Erza, Mirajane, Elfman, Lisanna all present (Lisanna is ALIVE)
- Laxus and Thunder Legion are elite members, not yet antagonistic
- Guild is peaceful but boisterous; Phantom Lord conflict hasn't happened
- Makarov is guild master, healthy and active

LEVY MCGARDEN (ROMANCE):
- Can appear naturally (reading, library, researching ancient scripts)
- Build romance SLOWLY: glances, brief exchanges, curiosity about your magic
- She's younger but already passionate about Solid Script magic and languages
- Often found with Jet and Droy (Shadow Gear forming)

FREED JUSTINE (RIVALRY):
- Captain of Thunder Legion - proud, elegant, exceptionally skilled
- Dark Écriture magic: writes runes that enforce absolute rules
- Initially DISMISSIVE of newcomers - they must prove their worth
- Triggers for rivalry: competing for missions, magical debates, perceived slights
- Triggers for respect: protecting guildmates, showing magical prowess, honorable conduct  
- He and Levy share love of written magic - this creates tension with your romance
- Does NOT antagonize without reason; rivalry builds through natural friction

Other guild members may appear with canon personalities (adjusted for being 5 years younger).
Adventures and missions can begin.` : '';

      const coherenceNotes = coherence.issues.length ? `\n═══ AVOID ═══\n${coherence.issues.join('; ')}` : '';
      const suggestions = coherence.suggestions.length ? `\n═══ INCORPORATE ═══\n${coherence.suggestions.join('\n')}` : '';
      const pacingNotes = coherence.pacingNotes ? `\n═══ PACING ═══\n${coherence.pacingNotes}` : '';

      const sys = `You are the MASTER NARRATOR of "Fairy Tail: Unknown Horizons."

═══ SCENE BEAT SYSTEM (CRITICAL) ═══
You write in SCENE BEATS - each response is ONE MOMENT in time.

BEAT RULES:
1. Maximum 5-10 minutes of story time per response
2. NEVER skip time unless the coherence pass indicates isTimeskip:true
3. NEVER use phrases like "hours pass", "time flies", "before long", "soon"
4. NEVER summarize - dramatize every moment
5. If character moves somewhere, describe the JOURNEY beat by beat
6. Focus on: sensory details, micro-expressions, small actions, atmosphere
7. End each beat at a natural pause that invites the next action

CURRENT MOMENT:
- Day ${gameState.temporal.day}, ${timePeriod.name}
- ${timePeriod.description}
- Beat #${gameState.temporal.beat}

${coherence.timeAdvance?.isTimeskip ? `
═══ TIMESKIP AUTHORIZED ═══
Player requested time skip. Narrate the transition poetically but briefly, then begin the new moment.
` : ''}

VOICE:
- Second person ("You...")
- Literary, evocative, atmospheric
- Sensory details: sounds, smells, magic's hum, textures, temperatures
- Real characters with body language and micro-expressions
- Present tense feeling - this is happening NOW
${prologueInstr}${guildInstr}${coherenceNotes}${suggestions}${pacingNotes}

RULES:
- Canon characters are IMMUTABLE
- Player character is an outsider
- Magic is real and awe-inspiring

CONTEXT:
${buildContext()}

Write 2-4 paragraphs for this ONE BEAT. End at a natural pause.`;

      let prompt;
      if (input === '__START_PROLOGUE__') {
        prompt = `BEGIN THE FIRST BEAT.

The character approaches Magnolia. This single beat: they crest a hill or round a bend, and see the town spread before them for the first time. The spires of the guild hall visible in the distance.

One moment. One breath. The weight of a year of running crystallizes into hope.`;
      } else if (input === '__ENTER_GUILD__') {
        prompt = `BEAT: THE DOORS OPEN.

One moment: hands on wood, pushing. The first rush of sound and warmth and light. The threshold crossing.

Describe THIS INSTANT - the sensory overwhelm of entering Fairy Tail for the first time. Perhaps glimpse Levy among the chaos. End as the character stands just inside, taking it in.`;
      } else {
        prompt = `BEAT: Player action - "${input}"

Continue with ONE SCENE BEAT responding to this action. Stay in the moment. No timeskips.`;
      }

      return await callGemini(prompt, sys, 0.8, true);  // includeHistory = true for narrative generation
    }

    // ============================================================
    // GAME LOGIC
    // ============================================================
    async function processAction(input) {
      showLoading(true);
      try {
        // PASS 1: Coherence & Pacing (ALWAYS)
        const coherence = await coherencePass(input);
        
        // PASS 2: Generate
        const narrative = await generationPass(input, coherence);

        // Apply time advancement
        if (coherence.timeAdvance) {
          if (coherence.timeAdvance.isTimeskip) {
            // Handle explicit timeskip
            if (coherence.timeAdvance.skipDays > 0) {
              gameState.temporal.day += coherence.timeAdvance.skipDays;
            }
            if (coherence.timeAdvance.skipToHour !== null) {
              // If skipping to earlier hour, it's next day
              if (coherence.timeAdvance.skipToHour <= gameState.temporal.hour && !coherence.timeAdvance.skipDays) {
                gameState.temporal.day++;
              }
              gameState.temporal.hour = coherence.timeAdvance.skipToHour;
            }
          } else {
            // Normal beat time advancement (1-10 minutes)
            advanceTime(coherence.timeAdvance.minutes || 5);
          }
        }

        // Advance beat counter
        advanceBeat();

        // Apply coherence updates
        if (coherence.conditionUpdate) gameState.character.condition = coherence.conditionUpdate;
        if (coherence.locationUpdate) gameState.story.currentLocation = coherence.locationUpdate;
        if (coherence.inventoryChanges?.add) gameState.inventory.push(...coherence.inventoryChanges.add);
        if (coherence.inventoryChanges?.remove) gameState.inventory = gameState.inventory.filter(i => !coherence.inventoryChanges.remove.includes(i));
        if (coherence.newFacts?.length) {
          gameState.story.establishedFacts.push(...coherence.newFacts);
          if (gameState.story.establishedFacts.length > 30) gameState.story.establishedFacts = gameState.story.establishedFacts.slice(-25);
        }
        if (coherence.levyPoints > 0) gameState.relationships.levy.points += coherence.levyPoints;
        
        // Apply Freed rivalry/respect changes
        if (coherence.freedRivalry) {
          gameState.relationships.freed.rivalry = Math.max(0, gameState.relationships.freed.rivalry + coherence.freedRivalry);
        }
        if (coherence.freedRespect) {
          gameState.relationships.freed.respect = Math.max(0, gameState.relationships.freed.respect + coherence.freedRespect);
        }

        // Update history with beat number
        gameState.story.narrativeHistory.push({
          action: input,
          summary: narrative.substring(0, 200).replace(/\n/g, ' ') + '...',
          timestamp: Date.now(),
          beat: gameState.temporal.beat - 1,
          day: gameState.temporal.day,
          time: getCurrentTimePeriod().name
        });
        if (gameState.story.narrativeHistory.length > 20) gameState.story.narrativeHistory = gameState.story.narrativeHistory.slice(-15);

        // Check for guild doors
        if (gameState.story.phase === 'prologue') {
          const lower = narrative.toLowerCase();
          const triggers = ['guild doors', 'guild hall doors', 'massive doors', 'great doors', 'stand before', 'standing before', 'reached the guild', 'before the doors', 'fairy tail doors', 'threshold'];
          if (triggers.some(t => lower.includes(t))) {
            gameState.story.atGuildDoors = true;
            gameState.story.currentLocation = 'Fairy Tail Guild (Entrance)';
          }
        }

        // Update conversation
        if (input !== '__START_PROLOGUE__' && input !== '__ENTER_GUILD__') {
          gameState.conversationHistory.push({ role: 'user', content: input });
        }
        gameState.conversationHistory.push({ role: 'assistant', content: narrative });
        if (gameState.conversationHistory.length > 24) gameState.conversationHistory = gameState.conversationHistory.slice(-20);

        saveGame();
        updateStatus();
        return narrative;
      } finally {
        showLoading(false);
        updateCoherence('');
      }
    }

    function awardExp(amt) {
      gameState.character.exp += amt;
      while (gameState.character.exp >= 100) {
        gameState.character.level++;
        gameState.character.exp -= 100;
        gameState.character.magicPower += Math.floor(Math.random() * 5) + 3;
      }
      updateStatus();
    }

    // ============================================================
    // UI
    // ============================================================
    function showLoading(show) {
      el.loadingIndicator.classList.toggle('active', show);
      el.sendButton.disabled = show;
      el.playerInput.disabled = show;
    }

    function updateCoherence(text) {
      el.coherenceIndicator.textContent = text;
    }

    function appendNarrative(text, isAction = false) {
      if (isAction) {
        // Add beat marker
        const beatMarker = document.createElement('div');
        beatMarker.className = 'beat-marker';
        beatMarker.textContent = `Beat ${gameState.temporal.beat}`;
        el.narrativeText.appendChild(beatMarker);
        
        const div = document.createElement('div');
        div.className = 'player-action';
        div.textContent = text;
        el.narrativeText.appendChild(div);
      } else {
        text.split(/\n\n+/).filter(p => p.trim()).forEach(p => {
          const pEl = document.createElement('p');
          pEl.textContent = p.trim();
          el.narrativeText.appendChild(pEl);
        });
      }
      setTimeout(() => window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }), 100);

      if (gameState.story.atGuildDoors && !gameState.story.enteredGuild) {
        el.prologueEnd.classList.remove('hidden');
        el.playerInput.disabled = true;
        el.sendButton.disabled = true;
      }
    }

    function updateStatus() {
      // Temporal
      const timeDisplay = formatTimeForDisplay();
      el.displayDay.textContent = gameState.temporal.day;
      el.displayTime.textContent = timeDisplay.time;
      el.displayPeriod.textContent = timeDisplay.description;
      el.displayBeat.textContent = gameState.temporal.beat;

      // Identity
      el.displayName.textContent = gameState.character.name || '—';
      el.displayMagic.textContent = gameState.character.magicType || '—';
      el.displayCondition.textContent = gameState.character.condition || '—';

      // Stats
      el.displayLevel.textContent = gameState.character.level;
      el.displayMagicPower.textContent = gameState.character.magicPower;
      el.expBar.style.width = `${gameState.character.exp}%`;

      // Inventory
      el.inventoryList.innerHTML = gameState.inventory.length
        ? gameState.inventory.map(i => `<li class="inventory-item">${i}</li>`).join('')
        : '<li class="inventory-empty">Nothing but the clothes on your back.</li>';

      // Levy
      if (gameState.relationships.levy.revealed) {
        el.levyStatus.textContent = getLevyStage().name;
        el.levyStatus.classList.remove('mystery');
      } else {
        el.levyStatus.textContent = '? ? ?';
        el.levyStatus.classList.add('mystery');
      }

      // Freed
      if (gameState.relationships.freed.revealed) {
        const freedStage = getFreedStage();
        const respectNote = gameState.relationships.freed.respect > 30 ? ' ✧' : '';
        el.freedStatus.textContent = freedStage.name + respectNote;
        el.freedStatus.classList.remove('mystery');
      } else {
        el.freedStatus.textContent = '? ? ?';
        el.freedStatus.classList.add('mystery');
      }

      el.chapterMarker.textContent = gameState.story.enteredGuild ? 'CHAPTER ONE' : 'PROLOGUE';
    }

    function showSave() {
      el.saveIndicator.classList.add('visible');
      setTimeout(() => el.saveIndicator.classList.remove('visible'), 2000);
    }

    function showError(msg) {
      const div = document.createElement('div');
      div.className = 'error-message';
      div.textContent = `Error: ${msg}`;
      el.narrativeText.appendChild(div);
      window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    }

    // ============================================================
    // SAVE/LOAD
    // ============================================================
    function saveGame() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(gameState));
        showSave();
      } catch (e) { console.error('Save failed:', e); }
    }

    function loadGame() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const loaded = JSON.parse(saved);
          gameState = {
            ...gameState,
            ...loaded,
            character: { ...gameState.character, ...loaded.character },
            relationships: { 
              levy: { ...gameState.relationships.levy, ...loaded.relationships?.levy },
              freed: { ...gameState.relationships.freed, ...loaded.relationships?.freed }
            },
            temporal: { ...gameState.temporal, ...loaded.temporal },
            story: { ...gameState.story, ...loaded.story }
          };
          return true;
        }
      } catch (e) { console.error('Load failed:', e); }
      return false;
    }

    function resetGame() {
      if (confirm('Abandon this journey? All progress will be lost forever.')) {
        localStorage.removeItem(STORAGE_KEY);
        location.reload();
      }
    }

    // ============================================================
    // GAME FLOW
    // ============================================================
    async function startNewGame() {
      const apiKey = el.apiKeyInput.value.trim();
      const name = el.charNameInput.value.trim();
      const magic = el.magicTypeInput.value.trim();
      const bio = el.biographyInput.value.trim();

      if (!apiKey) return showStatus('Please enter your Gemini API key.', 'error');
      if (!name) return showStatus('Your character needs a name.', 'error');
      if (!magic) return showStatus('What magic does your character wield?', 'error');
      if (!bio || bio.length < 50) return showStatus('Please provide more biography detail (50+ chars).', 'error');

      gameState.apiKey = apiKey;
      gameState.character.name = name;
      gameState.character.magicType = magic;
      gameState.character.biography = bio;

      el.beginButton.disabled = true;
      showStatus('Validating API key...', '');

      try {
        await callGemini('Say "ready" only.', '', 0.1);
        showStatus('Preparing your journey...', 'success');

        el.setupScreen.classList.add('hidden');
        el.gameScreen.classList.add('active');
        updateStatus();

        const prologue = await processAction('__START_PROLOGUE__');
        appendNarrative(prologue);
        awardExp(10);
      } catch (e) {
        showStatus(`Failed: ${e.message}`, 'error');
        el.beginButton.disabled = false;
      }
    }

    function continueGame() {
      el.setupScreen.classList.add('hidden');
      el.gameScreen.classList.add('active');
      updateStatus();

      let beatCounter = 0;
      gameState.conversationHistory.forEach((msg, i) => {
        if (msg.role === 'assistant') {
          const prev = gameState.conversationHistory[i - 1];
          if (prev?.role === 'user' && !['__START_PROLOGUE__', '__ENTER_GUILD__'].includes(prev.content)) {
            beatCounter++;
            // Add beat marker for restored content
            const beatMarker = document.createElement('div');
            beatMarker.className = 'beat-marker';
            beatMarker.textContent = `Beat ${beatCounter}`;
            el.narrativeText.appendChild(beatMarker);
            
            const actionDiv = document.createElement('div');
            actionDiv.className = 'player-action';
            actionDiv.textContent = prev.content;
            el.narrativeText.appendChild(actionDiv);
          }
          msg.content.split(/\n\n+/).filter(p => p.trim()).forEach(p => {
            const pEl = document.createElement('p');
            pEl.textContent = p.trim();
            el.narrativeText.appendChild(pEl);
          });
        }
      });

      if (gameState.story.atGuildDoors && !gameState.story.enteredGuild) {
        el.prologueEnd.classList.remove('hidden');
        el.playerInput.disabled = true;
        el.sendButton.disabled = true;
      }
    }

    async function handleInput() {
      const input = el.playerInput.value.trim();
      if (!input) return;

      el.playerInput.value = '';
      el.playerInput.style.height = 'auto';
      appendNarrative(input, true);

      try {
        const narrative = await processAction(input);
        appendNarrative(narrative);
        awardExp(Math.floor(Math.random() * 8) + 3);
      } catch (e) {
        showError(e.message);
      }
    }

    async function enterGuild() {
      el.prologueEnd.classList.add('hidden');
      gameState.story.enteredGuild = true;
      gameState.story.phase = 'chapter1';
      gameState.story.currentLocation = 'Fairy Tail Guild Hall';
      gameState.relationships.levy.revealed = true;
      gameState.relationships.freed.revealed = true;
      gameState.character.condition = 'Heart pounding with anticipation';
      gameState.story.establishedFacts.push(`${gameState.character.name} entered Fairy Tail for the first time`);

      updateStatus();
      saveGame();

      try {
        const div = document.createElement('div');
        div.className = 'narrative-divider';
        div.textContent = '• • •';
        el.narrativeText.appendChild(div);

        const narrative = await processAction('__ENTER_GUILD__');
        appendNarrative(narrative);
        el.playerInput.disabled = false;
        el.sendButton.disabled = false;
        el.playerInput.focus();
        awardExp(25);
      } catch (e) {
        showError(e.message);
        el.playerInput.disabled = false;
        el.sendButton.disabled = false;
      }
    }

    function showStatus(msg, type) {
      el.apiStatus.textContent = msg;
      el.apiStatus.className = 'api-status' + (type ? ` ${type}` : '');
    }

    // ============================================================
    // EVENTS
    // ============================================================
    el.beginButton.addEventListener('click', startNewGame);
    el.statusToggle.addEventListener('click', () => {
      el.statusPanel.classList.toggle('open');
      el.statusToggle.classList.toggle('active');
    });
    el.sendButton.addEventListener('click', handleInput);
    el.playerInput.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleInput(); }
    });
    el.playerInput.addEventListener('input', () => {
      el.playerInput.style.height = 'auto';
      el.playerInput.style.height = Math.min(el.playerInput.scrollHeight, 140) + 'px';
    });
    el.enterGuildButton.addEventListener('click', enterGuild);
    el.resetButton.addEventListener('click', resetGame);
    document.addEventListener('click', e => {
      if (el.statusPanel.classList.contains('open') && !el.statusPanel.contains(e.target) && !el.statusToggle.contains(e.target)) {
        el.statusPanel.classList.remove('open');
        el.statusToggle.classList.remove('active');
      }
    });

    // ============================================================
    // INIT
    // ============================================================
    if (loadGame() && gameState.apiKey && gameState.character.name) {
      continueGame();
    }
  </script>
</body>
</html>
